<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é£Ÿåˆ†æ - LUM ZenMind</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .food-card {
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            background-color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        .food-card img {
            border-radius: 8px;
            max-height: 150px;
            object-fit: cover;
        }
        .food-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .food-card .actions button { /* æ›´æ˜ç¢ºçš„é¸æ“‡å™¨ */
            margin-left: 5px; /* çµ¦æŒ‰éˆ•ä¸€äº›é–“è· */
            background-color: #5bc0de; /* Info color for edit */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .food-card .actions button.delete {
            background-color: #d9534f; /* Danger color for delete */
        }
        /* --- åœ¨ä½ ç¾æœ‰çš„ <style> æˆ– styles.css ä¸­æ–°å¢/ä¿®æ”¹ --- */

/* Modal åŸºæœ¬æ¨£å¼ */
.modal {
    display: none; /* åˆå§‹éš±è— */
    position: fixed; /* å›ºå®šå®šä½ï¼Œè¦†è“‹æ•´å€‹è¦–çª— */
    z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; /* å¦‚æœå…§å®¹éå¤šå‰‡å¯æ»¾å‹• */
    background-color: rgba(0,0,0,0.5); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯é®ç½© */
    padding-top: 50px; /* Modal è·é›¢é ‚éƒ¨çš„è·é›¢ï¼Œå¯èª¿æ•´ */
    box-sizing: border-box;
}

.modal-content {
    background-color: #fefefe;
    margin: auto; /* è‡ªå‹•ç½®ä¸­ */
    padding: 0; /* ç§»é™¤å…§é‚Šè·ï¼Œç”± header/body/footer æ§åˆ¶ */
    border: 1px solid #ddd;
    width: 90%; /* Modal å¯¬åº¦ï¼Œå¯ä¾éœ€æ±‚èª¿æ•´ */
    max-width: 500px; /* æœ€å¤§å¯¬åº¦ */
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative; /* ç‚ºäº†é—œé–‰æŒ‰éˆ•çš„å®šä½ */
    animation: fadeInModal 0.3s ease-out; /* ç°¡å–®å‹•ç•« */
}

@keyframes fadeInModal {
    from {opacity: 0; transform: translateY(-20px);}
    to {opacity: 1; transform: translateY(0);}
}

.modal-header {
    padding: 15px 20px;
    background-color: #007bff; /* ç¯„ä¾‹é¡è‰² (è—è‰²ç³») */
    color: white;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.4em;
}

.modal-body {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 18px; /* è¼¸å…¥æ¬„ä½é–“è· */
}

.modal-body label {
    font-weight: bold;
    margin-bottom: 6px;
    display: block;
    color: #333;
}

.modal-body input[type="text"],
.modal-body input[type="number"],
.modal-body input[type="date"],
.modal-body input[type="time"],
.modal-body input[type="file"] {
    width: 100%; /* ä½”æ»¿çˆ¶å®¹å™¨å¯¬åº¦ */
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box; /* ç¢ºä¿ padding å’Œ border ä¸æœƒå¢åŠ ç¸½å¯¬åº¦ */
    font-size: 1em;
}
.modal-body input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}


.modal-footer {
    padding: 15px 20px;
    text-align: right; /* æŒ‰éˆ•é å³ */
    background-color: #f9f9f9;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    border-top: 1px solid #eee;
}

.modal-footer button {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 10px;
    font-size: 1em;
    transition: background-color 0.2s ease;
}

.modal-footer button.confirm {
    background-color: #28a745; /* ç¶ è‰² */
    color: white;
}
.modal-footer button.confirm:hover {
    background-color: #218838;
}

.modal-footer button.cancel {
    background-color: #6c757d; /* ç°è‰² */
    color: white;
}
.modal-footer button.cancel:hover {
    background-color: #5a6268;
}

.close-button {
    color: white; /* åœ¨ modal-header ä¸­é¡è‰²ç‚ºç™½ */
    /* float: right; */ /* æ”¹ç”¨ flex å¾Œï¼Œfloat ä¸å†ç†æƒ³ */
    font-size: 28px;
    font-weight: bold;
    line-height: 1; /* ç¢ºä¿å‚ç›´å±…ä¸­ */
}

.close-button:hover,
.close-button:focus {
    color: #f1f1f1; /* æ»‘é¼ æ‡¸åœæ™‚é¡è‰²è®Šæ·º */
    text-decoration: none;
    cursor: pointer;
}

/* åœ–ç‰‡é è¦½ */
#imagePreviewContainer {
    margin-top: 10px;
    text-align: center;
}
#imagePreview {
    max-width: 100%;
    max-height: 200px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 8px;
    display: none; /* åˆå§‹éš±è— */
    object-fit: cover;
}
#removeImageButton {
    background-color: #dc3545; /* ç´…è‰² */
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    margin-top: 8px;
    display: none; /* åˆå§‹éš±è— */
}
#removeImageButton:hover {
    background-color: #c82333;
}

/* éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
.error-message {
    color: red;
    font-size: 0.85em;
    margin-top: 4px;
    display: none; /* åˆå§‹éš±è— */
}
    </style>
</head>
<body>
    <div>
        <h3>é£²é£Ÿç´€éŒ„ï¼š</h3>
        <div id="food-cards"></div>
    </div>

    <button onclick="openModal()" class="add-button">+</button>
    <!-- å¼•å…¥åº•éƒ¨å°èˆª -->
        <div id="bottom-nav"></div>


    <div id="foodModal" class="modal"> <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å¢é£²é£Ÿç´€éŒ„</h3>
                <span class="close-button" onclick="closeModal()">&times;</span> </div>
            <form id="foodForm"> <div class="modal-body">
                    <div>
                        <label for="foodName">é£Ÿç‰©åç¨±ï¼š</label>
                        <input type="text" id="foodName" placeholder="ä¾‹å¦‚ï¼šé›èƒ¸è‚‰æ²™æ‹‰" required>
                        <small class="error-message" id="foodNameError"></small>
                    </div>
                    <div>
                        <label for="foodCalories">å¡è·¯é‡Œ (å¤§å¡)ï¼š</label>
                        <input type="number" id="foodCalories" placeholder="ä¾‹å¦‚ï¼š350" required min="0">
                        <small class="error-message" id="foodCaloriesError"></small>
                    </div>
                    <div>
                        <label for="foodDate">æ—¥æœŸï¼š</label>
                        <input type="date" id="foodDate" required>
                    </div>
                    <div>
                        <label for="foodTime">æ™‚é–“ï¼š</label>
                        <input type="time" id="foodTime" required>
                    </div>
                    <div>
                        <label for="foodImage">é£Ÿç‰©åœ–ç‰‡ (é¸å¡«)ï¼š</label>
                        <input type="file" id="foodImage" accept="image/*" onchange="previewImageFile(this)"> <div id="imagePreviewContainer">
                            <img id="imagePreview" src="#" alt="åœ–ç‰‡é è¦½" />
                            <button type="button" id="removeImageButton" onclick="clearImagePreviewAndFile()">ç§»é™¤åœ–ç‰‡</button> </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="button" class="confirm" onclick="validateAndConfirmEdit()">ç¢ºèªå„²å­˜</button> </div>
            </form>
        </div>
    </div>

    
<script>
            // ä½¿ç”¨ fetch API è¼‰å…¥å°èˆªæ¬„
            fetch("/components/bottom-nav.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("bottom-nav").innerHTML = data;
                })
                .catch(err => console.error("ç„¡æ³•è¼‰å…¥å°èˆªæ¬„", err));
        </script>
    <script>
        // å…¨åŸŸè®Šæ•¸ (å¯è¢«æ¨¡çµ„æˆ–å…¶ä»–å…¨åŸŸå‡½å¼å­˜å–)
        let editTargetId = null;
        let imageSrc = ""; // ç”¨æ–¼åœ–ç‰‡é è¦½çš„ Data URL
        let userRequestedImageDeletion = false; // æ¨™è¨˜ç”¨æˆ¶æ˜¯å¦åœ¨ç·¨è¼¯æ™‚é»æ“Šäº†â€œç§»é™¤åœ–ç‰‡â€
        let currentEditImageURL = null; // ç”¨æ–¼ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œè¨˜éŒ„åŸå§‹åœ–ç‰‡çš„ URL
        
        // --- UI æ§åˆ¶å‡½å¼ (ä¸ç›´æ¥èˆ‡ Firebase SDK äº’å‹•) ---
        // ğŸš€ æ‰“é–‹ Modal
        // --- UI æ§åˆ¶å‡½å¼ ---
        function openModal(buttonOrNull = null) {
            const modal = document.getElementById('foodModal');
            const modalTitle = document.getElementById('modalTitle');
            const foodForm = document.getElementById('foodForm');
            foodForm.reset(); // é‡ç½®è¡¨å–®æ‰€æœ‰æ¬„ä½
            clearAllErrorMessages(); // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º

            // é‡ç½®åœ–ç‰‡ç›¸é—œç‹€æ…‹
            imageSrc = "";
            currentEditImageURL = null;
            userRequestedImageDeletion = false;
            document.getElementById('foodImage').value = null; // æ¸…ç©º file input
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '#';
            document.getElementById('removeImageButton').style.display = 'none';

            const now = new Date();
            const formattedDate = now.toISOString().split('T')[0];
            const formattedTime = now.toTimeString().split(' ')[0].substring(0, 5);

            if (buttonOrNull && typeof buttonOrNull.closest === 'function') { // ç·¨è¼¯æ¨¡å¼
                const card = buttonOrNull.closest('.food-card');
                if (!card) {
                    console.error("ç„¡æ³•æ‰¾åˆ° food-card å…ƒç´ ");
                    return;
                }
                modalTitle.innerText = "ç·¨è¼¯é£²é£Ÿç´€éŒ„";
                const name = card.querySelector('h4').innerText;
                const caloriesText = card.querySelector('p').innerText;
                const calories = caloriesText ? caloriesText.replace(' å¡', '') : '';
                const dateTimeText = card.querySelector('span').innerText;
                const [date, time] = dateTimeText ? dateTimeText.split(' ') : [formattedDate, formattedTime];
                const docId = card.getAttribute('data-id');
                const imgElement = card.querySelector('img');

                document.getElementById('foodName').value = name;
                document.getElementById('foodCalories').value = calories;
                document.getElementById('foodDate').value = date;
                document.getElementById('foodTime').value = time;
                modal.setAttribute('data-id', docId);

                if (imgElement && imgElement.src) {
                    currentEditImageURL = imgElement.src; // ä¿å­˜ç¾æœ‰åœ–ç‰‡ URL
                    document.getElementById('imagePreview').src = imgElement.src;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('removeImageButton').style.display = 'inline-block';
                }
            } else { // æ–°å¢æ¨¡å¼
                modalTitle.innerText = "æ–°å¢é£²é£Ÿç´€éŒ„";
                document.getElementById('foodDate').value = formattedDate;
                document.getElementById('foodTime').value = formattedTime;
                modal.removeAttribute('data-id');
            }
            modal.style.display = 'block';

            // é»æ“Š modal å¤–éƒ¨å€åŸŸé—œé–‰
            window.addEventListener('click', outsideModalClickListener);
            // æŒ‰ Esc éµé—œé–‰
            document.addEventListener('keydown', escapeKeyListener);
        }

        const outsideModalClickListener = (event) => {
            const modal = document.getElementById('foodModal');
            if (event.target == modal) {
                closeModal();
            }
        };

        const escapeKeyListener = (event) => {
            if (event.key === "Escape") {
                closeModal();
            }
        };

        function closeModal() {
            const modal = document.getElementById('foodModal');
            if (modal) modal.style.display = 'none';

            // æ¸…ç†åœ–ç‰‡ç›¸é—œç‹€æ…‹å’Œ DOM
            imageSrc = "";
            currentEditImageURL = null;
            userRequestedImageDeletion = false;
            document.getElementById('foodForm').reset(); // ç¢ºä¿è¡¨å–®è¢«é‡ç½®
            document.getElementById('foodImage').value = null;
            const imagePreviewEl = document.getElementById('imagePreview');
            if (imagePreviewEl) {
                imagePreviewEl.src = "#";
                imagePreviewEl.style.display = 'none';
            }
            const removeImageButtonEl = document.getElementById('removeImageButton');
            if (removeImageButtonEl) removeImageButtonEl.style.display = 'none';
            
            clearAllErrorMessages();

            // ç§»é™¤äº‹ä»¶ç›£è½å™¨
            window.removeEventListener('click', outsideModalClickListener);
            document.removeEventListener('keydown', escapeKeyListener);
        }

        // åœ–ç‰‡ç›¸é—œå‡½å¼ (å¦‚æœå•Ÿç”¨åœ–ç‰‡åŠŸèƒ½)
        function openCamera() { /* ... */ }
        function captureImage() { /* ... imageSrc = ...; */ }
        function previewImage(input) { /* ... reader.onload = function(e) { imageSrc = e.target.result; ... } ... */ }
        // æ¸…é™¤åœ–ç‰‡é è¦½å’Œæª”æ¡ˆé¸æ“‡
        function clearImagePreviewAndFile() {
            document.getElementById('foodImage').value = ""; // æ¸…ç©º file input çš„å€¼
            document.getElementById('imagePreview').src = '#';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('removeImageButton').style.display = 'none';
            imageSrc = ""; // Data URL æ¸…ç©º
            userRequestedImageDeletion = true; // æ¨™è¨˜ç”¨æˆ¶å¸Œæœ›ç§»é™¤ï¼ˆç¾æœ‰çš„ï¼‰åœ–ç‰‡
        }

        // è¡¨å–®é©—è­‰ä¸¦è§¸ç™¼å„²å­˜
        function validateAndConfirmEdit() {
            let isValid = true;
            clearAllErrorMessages(); // å…ˆæ¸…é™¤èˆŠçš„éŒ¯èª¤è¨Šæ¯

            const name = document.getElementById('foodName').value.trim();
            const calories = document.getElementById('foodCalories').value;
            const date = document.getElementById('foodDate').value;
            const time = document.getElementById('foodTime').value;

            if (!name) {
                showError('foodNameError', 'é£Ÿç‰©åç¨±ä¸èƒ½ç‚ºç©º');
                isValid = false;
            }
            if (!calories) {
                showError('foodCaloriesError', 'å¡è·¯é‡Œä¸èƒ½ç‚ºç©º');
                isValid = false;
            } else if (isNaN(calories) || Number(calories) < 0) {
                showError('foodCaloriesError', 'å¡è·¯é‡Œå¿…é ˆæ˜¯æœ‰æ•ˆçš„éè² æ•¸å­—');
                isValid = false;
            }
            if (!date) {
                // HTML5 date input é€šå¸¸æœƒè‡ªè¡Œé©—è­‰ï¼Œä½†å¯è¦–æƒ…æ³å¢åŠ 
                showError('foodDateError', 'è«‹é¸æ“‡æ—¥æœŸ'); // å‡è¨­æœ‰ foodDateError å…ƒç´ 
                isValid = false;
            }
            if (!time) {
                // HTML5 time input é€šå¸¸æœƒè‡ªè¡Œé©—è­‰
                showError('foodTimeError', 'è«‹é¸æ“‡æ™‚é–“'); // å‡è¨­æœ‰ foodTimeError å…ƒç´ 
                isValid = false;
            }

            if (isValid) {
                confirmEdit(); // å¦‚æœé©—è­‰é€šéï¼Œæ‰åŸ·è¡ŒåŸä¾†çš„ confirmEdit
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block'; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            }
        }

        // æ¸…é™¤æ‰€æœ‰è¡¨å–®éŒ¯èª¤è¨Šæ¯
        function clearAllErrorMessages() {
            const errorMessages = document.querySelectorAll('.error-message'); // æ ¹æ“šä½ çš„ class é¸æ“‡
            errorMessages.forEach(el => {
                el.textContent = '';
                el.style.display = 'none'; // éš±è—
            });
        }


        // --- CRUD åŠè³‡æ–™é¡¯ç¤ºå‡½å¼ (å°‡ä¾è³´æ¨¡çµ„ä¸­æš´éœ²çš„ Firebase æ–¹æ³•) ---
        function createCard(name, calories, date, time, imageSrcUrl, docId) {
            const foodCardsContainer = document.getElementById('food-cards');
            if (!foodCardsContainer) return;

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ docId çš„å¡ç‰‡ï¼Œé¿å…é‡è¤‡ (é›–ç„¶åˆ†é é‚è¼¯æ‡‰è™•ç†ï¼Œä½†å¤šä¸€å±¤ä¿è­·)
            if (document.querySelector(`.food-card[data-id="${docId}"]`)) {
                console.warn(`ID ç‚º ${docId} çš„å¡ç‰‡å·²å­˜åœ¨ï¼Œè·³éå‰µå»ºã€‚`);
                return;
            }
            
            const foodCard = document.createElement('div');
            foodCard.classList.add('food-card');
            foodCard.setAttribute('data-id', docId);

            foodCard.innerHTML = `
                <div class="food-card-header">
                    <h4>${name}</h4>
                    <div class="actions">
                        <button onclick="openModal(this)">âœï¸ ç·¨è¼¯</button>
                        <button onclick="removeCard('${docId}', this)" class="delete">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
                <p>${calories} å¡</p>
                <span>${date} ${time}</span>
                ${imageSrcUrl ? `<img src="${imageSrcUrl}" alt="${name}">` : ''}
            `;
            // æ–°å¢çš„å¡ç‰‡ï¼Œå¦‚æœå¸Œæœ›æŒ‰æ™‚é–“é †åºé¡¯ç¤ºåœ¨æœ€å‰é¢ (å‡è¨­æ˜¯é™åº)
            if (foodCardsContainer.firstChild) {
                foodCardsContainer.insertBefore(foodCard, foodCardsContainer.firstChild);
            } else {
                foodCardsContainer.appendChild(foodCard);
            }
        }
        
        // ä¿®æ”¹å¾Œçš„ confirmEdit (ä¸»è¦èª¿æ•´åœ–ç‰‡è™•ç†é‚è¼¯)
async function confirmEdit() {
    const name = document.getElementById('foodName').value.trim();
    const calories = document.getElementById('foodCalories').value;
    const date = document.getElementById('foodDate').value;
    const time = document.getElementById('foodTime').value;
    const modal = document.getElementById('foodModal');
    const docId = modal.getAttribute('data-id'); // null if adding new

    // åŸºæœ¬é©—è­‰ (é›–ç„¶ validateAndConfirmEdit åšäº†ï¼Œé€™è£¡å†ä¿éšªä¸€ä¸‹)
    if (!name || !calories || !date || !time) {
        alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼"); // ç†è«–ä¸Šä¸æœƒåŸ·è¡Œåˆ°é€™
        return;
    }
    if (!window.currentUserId) {
        alert("ä½¿ç”¨è€…æœªç™»å…¥æˆ–ç„¡æ³•ç²å–ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
        return;
    }

    const dataToSave = {
        userId: window.currentUserId,
        name,
        calories: Number(calories),
        date,
        time,
        image: "" // é è¨­åœ–ç‰‡ç‚ºç©º
    };

    try {
        let oldImageURLToDelete = null;

        // 1. è™•ç†åœ–ç‰‡ä¸Šå‚³/æ›´æ–°/åˆªé™¤
        if (imageSrc) { // æœ‰æ–°é¸æ“‡çš„åœ–ç‰‡ (imageSrc æ˜¯æ–°åœ–çš„ Data URL)
            console.log("ä¸Šå‚³æ–°åœ–ç‰‡...");
            const imageFileRef = window.FirebaseStorageRefs.ref(window.storage, `foodImages/${window.currentUserId}/${Date.now()}.png`); // å‡è¨­éƒ½è½‰æˆ png
            await window.FirebaseStorageMethods.uploadString(imageFileRef, imageSrc, 'data_url');
            dataToSave.image = await window.FirebaseStorageMethods.getDownloadURL(imageFileRef);
            
            if (docId && currentEditImageURL) { // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œä¸”ä¹‹å‰æœ‰åœ–ç‰‡ï¼Œå‰‡æ¨™è¨˜èˆŠåœ–ç‰‡å¾…åˆªé™¤
                oldImageURLToDelete = currentEditImageURL;
            }
        } else if (docId && currentEditImageURL) { // ç·¨è¼¯æ¨¡å¼ï¼Œä¸”æ²’æœ‰æ–°é¸åœ–ç‰‡
            if (userRequestedImageDeletion) { // ç”¨æˆ¶é»äº† "ç§»é™¤åœ–ç‰‡"
                console.log("ç”¨æˆ¶è«‹æ±‚åˆªé™¤ç¾æœ‰åœ–ç‰‡...");
                dataToSave.image = ""; // è³‡æ–™åº«ä¸­åœ–ç‰‡æ¬„ä½æ¸…ç©º
                oldImageURLToDelete = currentEditImageURL; // æ¨™è¨˜èˆŠåœ–ç‰‡å¾…åˆªé™¤
            } else {
                // ç”¨æˆ¶æœªé¸æ“‡æ–°åœ–ï¼Œä¹Ÿæœªé»æ“Šç§»é™¤ -> ä¿ç•™åŸæœ‰åœ–ç‰‡
                console.log("ä¿ç•™åŸæœ‰åœ–ç‰‡...");
                dataToSave.image = currentEditImageURL;
            }
        }
        // å…¶ä»–æƒ…æ³ (æ–°å¢ä¸”ç„¡åœ–ï¼Œæˆ–ç·¨è¼¯æ™‚æœ¬ç„¡åœ–ä¹Ÿæœªé¸æ–°åœ–)ï¼ŒdataToSave.image å·²æ˜¯ ""

        // 2. å„²å­˜è³‡æ–™åˆ° Firestore
        if (docId) { // æ›´æ–°ç¾æœ‰è¨˜éŒ„
            const docRef = window.FirebaseMethods.doc(window.db, "foodRecords", docId);
            await window.FirebaseMethods.updateDoc(docRef, dataToSave);
            console.log(`âœ… è³‡æ–™å·²æ›´æ–°ï¼š${docId}`);

            // æ›´æ–°å‰ç«¯å°æ‡‰å¡ç‰‡çš„é¡¯ç¤º
            const cardToUpdate = document.querySelector(`.food-card[data-id="${docId}"]`);
            if (cardToUpdate) {
                cardToUpdate.querySelector('h4').innerText = dataToSave.name;
                cardToUpdate.querySelector('p').innerText = `${dataToSave.calories} å¡`;
                cardToUpdate.querySelector('span').innerText = `${dataToSave.date} ${dataToSave.time}`;
                const imgElement = cardToUpdate.querySelector('img');
                if (dataToSave.image) {
                    if (imgElement) {
                        imgElement.src = dataToSave.image;
                        imgElement.alt = dataToSave.name;
                        imgElement.style.display = 'block'; // ç¢ºä¿å¯è¦‹
                    } else {
                        const newImg = document.createElement('img');
                        newImg.src = dataToSave.image;
                        newImg.alt = dataToSave.name;
                        cardToUpdate.appendChild(newImg); // æˆ–æ’å…¥åˆ°åˆé©ä½ç½®
                    }
                } else if (imgElement) {
                    imgElement.remove(); // å¦‚æœæ›´æ–°å¾Œæ²’æœ‰åœ–ç‰‡ï¼Œç§»é™¤åœ–ç‰‡å…ƒç´ 
                }
            }
        } else { // æ–°å¢è¨˜éŒ„
            const newDocRef = await window.FirebaseMethods.addDoc(window.FirebaseMethods.collection(window.db, "foodRecords"), dataToSave);
            console.log("âœ… è³‡æ–™å·²æ–°å¢è‡³ Firebase, ID:", newDocRef.id);
            createCard(dataToSave.name, dataToSave.calories, dataToSave.date, dataToSave.time, dataToSave.image, newDocRef.id);
        }

        // 3. å¦‚æœæœ‰èˆŠåœ–ç‰‡éœ€è¦åˆªé™¤ï¼Œå‰‡å¾ Storage ä¸­åˆªé™¤
        if (oldImageURLToDelete) {
            console.log("å˜—è©¦å¾ Storage åˆªé™¤èˆŠåœ–ç‰‡:", oldImageURLToDelete);
            try {
                // ç¢ºä¿ä½ çš„ FirebaseStorageMethods åŒ…å« deleteObject
                const oldImageRef = window.FirebaseStorageRefs.ref(window.storage, oldImageURLToDelete);
                await window.FirebaseStorageMethods.deleteObject(oldImageRef);
                console.log("ğŸ—‘ï¸ èˆŠåœ–ç‰‡å·²å¾ Storage åˆªé™¤ã€‚");
            } catch (e) {
                console.warn("åˆªé™¤ Storage ä¸­çš„èˆŠåœ–ç‰‡å¤±æ•— (å¯èƒ½å·²è¢«åˆªé™¤æˆ–ä¸å­˜åœ¨):", e.message);
            }
        }

        closeModal();
    } catch (error) {
        console.error("âŒ è³‡æ–™å„²å­˜å¤±æ•—ï¼š", error.message, error);
        // å¯ä»¥åœ¨ Modal å…§é¡¯ç¤ºæ›´å‹å¥½çš„éŒ¯èª¤è¨Šæ¯ï¼Œè€Œä¸æ˜¯ alert
        showError('foodFormError', `å„²å­˜å¤±æ•—ï¼š${error.message}`); // å‡è¨­ modal-footer æˆ– body æœ‰å€‹ <small id="foodFormError"></small>
        // alert("è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
    }
}

       // `removeCard` å‡½æ•¸ä¹Ÿæ‡‰åŒ…å«åˆªé™¤ Storage åœ–ç‰‡çš„é‚è¼¯
async function removeCard(docId, buttonElement) {
    if (!docId) {
        console.error("ç„¡æ•ˆçš„æ–‡æª” ID");
        return;
    }
    const cardElement = buttonElement.closest('.food-card');
    let imageUrlToDelete = null;
    if (cardElement) {
        const imgElement = cardElement.querySelector('img');
        if (imgElement && imgElement.src && imgElement.src.startsWith("https://firebasestorage.googleapis.com/")) {
            imageUrlToDelete = imgElement.src;
        }
    }

    if (confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†é£²é£Ÿç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
        try {
            // 1. åˆªé™¤ Firestore æ–‡æª”
            const docRef = window.FirebaseMethods.doc(window.db, "foodRecords", docId);
            await window.FirebaseMethods.deleteDoc(docRef);
            console.log(`ğŸ—‘ï¸ å·²å¾ Firebase åˆªé™¤è³‡æ–™ï¼š${docId}`);
            
            // 2. å¦‚æœæœ‰é—œè¯çš„åœ–ç‰‡ï¼Œå¾ Storage åˆªé™¤
            if (imageUrlToDelete) {
                console.log("æº–å‚™åˆªé™¤ Storage ä¸­çš„åœ–ç‰‡:", imageUrlToDelete);
                try {
                    const imageRefToDelete = window.FirebaseStorageRefs.ref(window.storage, imageUrlToDelete);
                    await window.FirebaseStorageMethods.deleteObject(imageRefToDelete); // <--- ***ç¢ºä¿æ­¤æ–¹æ³•å·²æš´éœ²***
                    console.log(`ğŸ—‘ï¸ å·²å¾ Firebase Storage åˆªé™¤åœ–ç‰‡ï¼š${imageUrlToDelete}`);
                } catch (storageError) {
                    console.warn("åˆªé™¤ Storage ä¸­çš„åœ–ç‰‡å¤±æ•— (å¯èƒ½å·²è¢«åˆªé™¤æˆ–æ¬Šé™å•é¡Œ)ï¼š", storageError.message);
                    // é€šå¸¸ä¸æ‡‰é˜»æ–·ä¸»åˆªé™¤æµç¨‹ï¼Œè¨˜éŒ„è­¦å‘Šå³å¯
                }
            }

            // 3. å¾å‰ç«¯ç§»é™¤å¡ç‰‡
            if (cardElement) {
                cardElement.remove();
            }
        } catch (error) {
            console.error("âŒ åˆªé™¤ Firebase è³‡æ–™å¤±æ•—ï¼š", error.message, error);
            alert("åˆªé™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
    }
}

        // --- åˆ†é è¼‰å…¥ç›¸é—œè®Šæ•¸å’Œå‡½å¼ (å°‡ä¾è³´æ¨¡çµ„ä¸­æš´éœ²çš„ Firebase æ–¹æ³•) ---
        let lastVisibleDoc = null; // Firestore DocumentSnapshot for pagination
        const recordsPerPage = 5;  // æ¯é è¼‰å…¥çš„è¨˜éŒ„æ•¸
        let isLoadingMore = false; // é˜²æ­¢é‡è¤‡è§¸ç™¼è¼‰å…¥

        async function loadMoreFoodRecords(isInitialLoad = false) {
            if (isLoadingMore) return;
            if (!window.currentUserId) { // ç¢ºä¿ userId å·²è¨­å®š
                console.log("ä½¿ç”¨è€…æœªç™»å…¥ï¼Œæš«åœè¼‰å…¥è³‡æ–™ã€‚");
                return;
            }
            isLoadingMore = true;
            console.log(isInitialLoad ? "ğŸ”„ æ­£åœ¨åˆå§‹è¼‰å…¥é£²é£Ÿç´€éŒ„..." : "ğŸ”„ æ­£åœ¨è¼‰å…¥æ›´å¤šé£²é£Ÿç´€éŒ„...");

            const foodCardsContainer = document.getElementById('food-cards');
            if (isInitialLoad) {
                foodCardsContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å¡ç‰‡
                lastVisibleDoc = null; // é‡ç½®åˆ†é æ¸¸æ¨™
            }

            try {
                const FBM = window.FirebaseMethods; // ç°¡å¯«
                const commonQueries = [
                    FBM.where("userId", "==", window.currentUserId),
                    FBM.orderBy("date", "desc"),
                    FBM.orderBy("time", "desc"), // æ¬¡è¦æ’åºä¾æ“šæ™‚é–“
                    FBM.limit(recordsPerPage)
                ];

                let q;
                if (lastVisibleDoc && !isInitialLoad) {
                    q = FBM.query(FBM.collection(window.db, "foodRecords"), ...commonQueries, FBM.startAfter(lastVisibleDoc));
                } else {
                    q = FBM.query(FBM.collection(window.db, "foodRecords"), ...commonQueries);
                }

                const querySnapshot = await FBM.getDocs(q);

                if (querySnapshot.empty) {
                    console.log(isInitialLoad ? "æš«ç„¡é£²é£Ÿç´€éŒ„ã€‚" : "ğŸ å·²è¼‰å…¥æ‰€æœ‰é£²é£Ÿç´€éŒ„ã€‚");
                    if (!isInitialLoad) { // å¦‚æœä¸æ˜¯åˆå§‹è¼‰å…¥ä¸”çµæœç‚ºç©ºï¼Œå‰‡ç§»é™¤æ²å‹•ç›£è½
                        window.removeEventListener("scroll", handleScroll);
                    }
                } else {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        createCard(data.name, data.calories, data.date, data.time, data.image, doc.id);
                    });
                    lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    if (isInitialLoad && querySnapshot.docs.length === recordsPerPage) { // åˆå§‹è¼‰å…¥ä¸”å¯èƒ½é‚„æœ‰æ›´å¤š
                        window.addEventListener("scroll", handleScroll);
                    } else if (querySnapshot.docs.length < recordsPerPage) { // è¼‰å…¥çš„ç­†æ•¸å°‘æ–¼è«‹æ±‚ç­†æ•¸ï¼Œè¡¨ç¤ºåˆ°åº•äº†
                         window.removeEventListener("scroll", handleScroll);
                         console.log("ğŸ å·²è¼‰å…¥æ‰€æœ‰é£²é£Ÿç´€éŒ„ (å› å›å‚³ç­†æ•¸å°‘æ–¼è«‹æ±‚)ã€‚");
                    }
                }
            } catch (error) {
                console.error("âŒ è¼‰å…¥é£²é£Ÿç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error.message, error);
            } finally {
                isLoadingMore = false;
            }
        }

        function handleScroll() {
            // æ¥è¿‘åº•éƒ¨ 150px æ™‚ï¼Œä¸”ä¸åœ¨è¼‰å…¥ä¸­ï¼Œä¸”é‚„æœ‰æ›´å¤šè³‡æ–™ (lastVisibleDoc å­˜åœ¨)
            if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 150) && !isLoadingMore && lastVisibleDoc) {
                loadMoreFoodRecords(false);
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, 
            query, where, orderBy, startAfter, limit 
            // onSnapshot // æš«æ™‚ä¸ç”¨ï¼Œè‹¥è¦å³æ™‚æ›´æ–°éœ€è¬¹æ…æ•´åˆ
        } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js"; // storage 'ref' renamed to 'storageRef'

        const firebaseConfig = {
            apiKey: "AIzaSyBMPBJOBzSrJZUHK781948I_ROqVux3YHI",
            authDomain: "lumzenmind.firebaseapp.com",
            projectId: "lumzenmind",
            storageBucket: "lumzenmind.appspot.com",
            messagingSenderId: "1028669516548",
            appId: "1:1028669516548:web:3888d2c7bd5d1747207e51",
            measurementId: "G-DMYR2Q35NG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // å°‡ Firebase SDK çš„æ–¹æ³•å’Œå¯¦ä¾‹æš´éœ²åˆ°å…¨åŸŸï¼Œä¾›éæ¨¡çµ„ <script> ä½¿ç”¨
        window.db = db;
        window.authInstance = auth; // å¯ä»¥ç”¨ä¾†ç²å– currentUser
        window.storage = storage;   // æš´éœ² storage å¯¦ä¾‹

        window.FirebaseMethods = {
            doc, deleteDoc, addDoc, updateDoc, collection, getDocs, 
            query, where, orderBy, startAfter, limit
        };
        // æš´éœ² Storage ç›¸é—œæ–¹æ³• (æ³¨æ„ storage çš„ ref èˆ‡ firestore çš„ ref åç¨±è¡çªï¼Œå·²é‡å‘½å)
        window.FirebaseStorageRefs = { ref: storageRef }; // ä½¿ç”¨ storageRef
        window.FirebaseStorageMethods = { uploadString, getDownloadURL , deleteObject };


        // å°‡å…¨åŸŸå®šç¾©çš„ UI å‡½å¼æ›åˆ° windowï¼Œç¢ºä¿ onclick åŠæ¨¡çµ„å…§å‘¼å«å¯æ‰¾åˆ°å®ƒå€‘
        // é€™äº›å‡½å¼å®šç¾©åœ¨ä¸Šé¢çš„ <script> æ¨™ç±¤ä¸­
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.confirmEdit = confirmEdit; // confirmEdit è£¡é¢æœƒç”¨åˆ° window.FirebaseMethods ç­‰
        window.removeCard = removeCard;   // removeCard è£¡é¢æœƒç”¨åˆ° window.FirebaseMethods ç­‰
        window.createCard = createCard;

        // å¦‚æœå•Ÿç”¨äº†åœ–ç‰‡åŠŸèƒ½
        // window.openCamera = openCamera;
        // window.captureImage = captureImage;
        // window.previewImage = previewImage;


        onAuthStateChanged(auth, (user) => {
            const foodCardsContainer = document.getElementById('food-cards');
            if (user) {
                console.log("ä½¿ç”¨è€…å·²ç™»å…¥:", user.email, user.uid);
                window.currentUserId = user.uid; // å°‡ç•¶å‰ userId å­˜åˆ°å…¨åŸŸè®Šæ•¸
                if (typeof loadMoreFoodRecords === 'function') {
                    loadMoreFoodRecords(true); // è§¸ç™¼åˆå§‹è³‡æ–™è¼‰å…¥
                } else {
                    console.error("loadMoreFoodRecords å‡½å¼æœªå®šç¾©ï¼");
                }
            } else {
                console.log("ä½¿ç”¨è€…å·²ç™»å‡ºæˆ–æœªç™»å…¥ã€‚");
                window.currentUserId = null;
                if (foodCardsContainer) foodCardsContainer.innerHTML = '<p>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„é£²é£Ÿç´€éŒ„ã€‚</p>';
                lastVisibleDoc = null; // æ¸…é™¤åˆ†é æ¸¸æ¨™
                window.removeEventListener("scroll", handleScroll); // ç§»é™¤æ²å‹•ç›£è½
                // window.location.href = "/login.html"; // ä¾‹å¦‚å°å‘ç™»å…¥é é¢
            }
        });

        // åœç”¨åŸºæ–¼ onSnapshot çš„ loadFromFirestoreï¼Œä»¥åˆ†é ç‚ºä¸»
        /*
        function loadFromFirestore() {
            // ... onSnapshot logic here ...
            // If re-enabled, ensure it correctly filters by userId and handles pagination carefully.
        }
        */
    </script>
</body>
</html>